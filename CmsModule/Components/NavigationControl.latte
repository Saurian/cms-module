{cache $cacheKey, tags => [\CmsModule\Content\Entities\PageEntity::CACHE, \CmsModule\Content\Entities\RouteEntity::CACHE]}

{var root=>$control->getRoot()}

{if $root}
{define #menu}

	{foreach $items as $item}

		{var entity=>$item->getPageWithLanguageAlias($presenter->lang)}
		{continueIf $entity===NULL}

		{var active=>$control->isActive($entity)}
		{var link=>$control->getLink($entity)}

		{var childrens=>($sub < ($startDepth + $maxDepth - 1)) && ($active || !$followActive) && count($item->childrens) > 0}

		{if $sub < $startDepth}
			{if $item->childrens->count() > 0 && ($active || !$followActive)}
				{include #menu, "items"=>$item->childrens, "sub"=>($sub+1), "first"=>true}
			{/if}
		{else}

{if $iterator->isFirst()}
<ul {if !$first}class="dropdown-menu"{else}class="nav"{/if}>
		{if $first && $showMain && $root->navigationShow}
            {include #item active=>$presenter->route->url === '', childrens=>array(), link=>$presenter->link('this', array('route'=>$root->mainRoute)), entity=>$root->getPageWithLanguageAlias($presenter->lang), item=>$root}
		{/if}
{/if}

			{if $entity->navigationShow}
				{include #item active=>$active, childrens=>$childrens, link=>$link, entity=>$entity, item=>$item, sub=>$sub}
			{/if}
		{/if}

	{/foreach}
</ul>
{/define}

{define #item}
	<li class="{if $active} active{/if}{if $childrens} dropdown{/if}">
		<a href="{$link}" class="{if $active} active{/if}{if $childrens} dropdown-toogle" data-toggle="dropdown{/if}">{$entity->navigationTitle}</a>

		{if $childrens}
		{include #menu "items"=>$item->childrens, "sub"=>($sub+1), first=>false}
		{/if}
	</li>
{/define}

{include #menu "items"=>$root->childrens, "sub"=>0, "first"=>true, root=>$root}

{/if}
{/cache}
